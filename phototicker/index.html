<html>
  <head>
    <title>photo ticker</title>
    <link rel="stylesheet" type="text/css" href="phototicker.css"/>
    <script type="text/javascript" src="../js/jquery.min.js"></script>   
  </head>
  <body>
    <ul id="content"></ul>
    <div id="waiting" class="clearfix">
      <div class="waiting-text">Waiting for photos...</div>
      <a id="logo" href="http://meetup.com/api"><img src="../img/smalllogo.png"/></a>
    </div>
    <script type="text/javascript">
      /*
  Meetup Streaming API client for WebSockets and long-polling endpoints.

  These functions provide a universal interface for both
  protocols. You supply a callback function to respond to the json,
  and any parameters you want to be included. For example, to alert
  with the member_id for every RSVP in the event "1234":

      var stream = mu.Rsvps(function(json) {
          alert(json.member.member_id);
      }, { event_id: 1234 });

  If you ever wish to stop the cycle of callbacks, call stop()
  on the object returned.

      stream.stop();

  To restart the stream, create a new one with the function above.

  This client requires jQuery 1.4 or higher.
*/

mu = window.mu || {};

mu.Rsvps = function(callback, params, error) {
    return mu.Stream({
        url: "http://stream.meetup.com/2/rsvps",
        callback: callback,
        error: error,
        params: params
    });
};

mu.Photos = function(callback, params, error) {
    return mu.Stream({
        url: "http://stream.meetup.com/2/photos",
        callback: callback,
        error: error,
        params: params
    });
};

mu.Checkins = function(callback, params, error) {
    return mu.Stream({
        url: "http://stream.meetup.com/2/checkins",
        callback: callback,
        error: error,
        params: params
    });
};

mu.Comments = function(callback, params, error) {
    return mu.Stream({
        url: "http://stream.meetup.com/2/event_comments",
        callback: callback,
        params: params,
        error: error
    });
};

/**
 * @param config object that defines the following options
 *  url - http url for the stream
 *  wsUrl - websockets url for the stream
 *  callback - callback for messages, parameter is one JS object
 *  log    - function that logs a msg
 *  error  - function called when an error occurs
 */
mu.Stream = (function(config) {
    var $ = jQuery;
    var url = config.url || "http://stream.meetup.com/2/rsvps",
      wsUrl = config.wsUrl || url.replace(/^http/, 'ws'),
      log = config.log || function(msg) { },
      stopping = false,
      error = config.error || function(msg) {
         alert(msg);
      },
      handleJson = function(json) {
        if(typeof config.callback === "function") {
            config.callback(json);
        } else {
            error("callback is not a function");
        }
      },
      supportsWebsockets = function() {
          return window.WebSocket || window.MozWebSocket;
      };

    if(supportsWebsockets()) {
        if (config.params)
            wsUrl = wsUrl + "?" + $.param(config.params);
        var s = window.WebSocket ? new WebSocket(wsUrl) : new MozWebSocket(wsUrl);
        s.onmessage = function(e) {
            if (stopping) {
                s.close();
            } else {
                var ary = JSON.parse(e.data);
                if(ary.errors) {
                   error(ary.errors);
                } else {
                  handleJson(ary);
                }
            }
        };
    } else {
        var newest = 0;
        var successCallback = function(ary) {
            if (!stopping) {
              if (ary) {
                if(ary.errors) {
                    stopping = true;
                    error(ary.errors);
                } else {
                  $.each(ary, function() {
                      handleJson(this);
                      newest = Math.max(newest, this.mtime);
                  });
                }
              }
              if(!stopping) {
                  var params = config.params || {};
                  if (newest > 0) {
                      params.since_mtime = newest;
                      delete params.since_count;
                  }
                  $.ajax({
                       url: url,
                       data: params,
                       dataType: 'jsonp',
                       success: successCallback,
                       scriptCharset: 'UTF-8'
                  });
              }
            }
        };
        mu.Loader.defer(function () {
            successCallback();
        });
    }
    return {
        stop: function() {
            stopping = true;
        }
    };
});
/** Defers tasks until page has loaded, makes progress bars less likely to spin forever */
mu.Loader = {
    hasLoaded: false,
    defer: function(task) {
        if (mu.Loader.hasLoaded) {
            setTimeout(task, 50);
        } else {
            $(window).load(task);
        }
    },
    _load: function() {
        mu.Loader.hasLoaded = true;
    }
};
$(window).load(mu.Loader._load);

    </script>
    <!--<script type="text/javascript"
            src="http://static2.meetupstatic.com/24087933819704228/script/api/mu.js"></script>-->
    <script type="text/javascript" src="../js/mu.time.js"></script>
    <script type="text/javascript" src="phototicker.js"></script>
   </body>
</html>