<!DOCTYPE html>
<html>
  <head>
    <title>Meetup</title>
    <link href="../css/jquery.bubblepopup.v2.3.1.css" rel="stylesheet" type="text/css" />
    <link type="text/css" rel="stylesheet" href="photos.css" />
    <script type="text/javascript" src="../js/jquery.min.js"></script>
  </head>
  <body>

  	<div id="grid">
    	<ul id="people" class="clearfix"></ul>
    </div>
    <div id="big-img">
  		<img src="MeetupBig.png" />
  	</div>
    <script type="text/javascript" src="http://static1.meetupstatic.com/script/Meetup/api/mu.js"></script>
    <script type="text/javascript" src="../js/jquery.bubblepopup.v2.3.1.min.js"></script>
    <script type="text/javascript" src="../js/color.js"></script>
    <script type="text/javascript" src="../js/arrays.js"></script>
    <script type="text/javascript">
      $(function() {
          var p =  $("#people"), colMax = 0, rowMax = 0;;
          var Grid = (function() {
            var picWidth = 100,
              picHeight = 100,
              slots = [],
              full = false,
              dimensions = function() {
                return {
                    width: $("#grid").width(),
                    height: $("#grid").height()
                }
              },
              nextSlot = function() {
                  var next = slots.shift();
                  slots.push(next);
                  return $(['#r-', next[0], '-c-', next[1]].join(''));
              };

            return {
                randomSlot: function() {
                    return slots[Math.floor(Math.random() * slots.length)];
                },
                fill: function() {
                    p.empty();
                    slots = [];
                    var d = dimensions(),
                    rows =  Math.floor(d.height / picHeight) - 1,
                    cols = Math.floor(d.width / picWidth) - 1;
                    for(var r = 0; r < rows; r++) {
                        for(var c = 0; c < cols; c++) {
                            var li =$(['<li id="r-', r, '-c-', c, '"></li>'].join(''));
                            slots.push([r,c]);
                            p.append(li);
                        }
                    }
                    slots.shuffle();
                },
                add: function(photo) {
                    var inject = function (el) {
                        var content = ['<a target="_blank" href="'+photo.photo_link+'"><span><img src="',photo.photo_link,'"/></span></a>'].join(''),
                          msg = ['<img class-"member-photo" src="',photo.thumb_link,
                             '"/><div class="rsvp-info"><span class="member">', photo.member.name,
                             '</span><br/> just posted a photo!</div>'].join(''),
                          bubbleOpts = {
                            themePath: '../images/jquerybubblepopup-theme',
                            themeName: 'all-black',
                            innerHtml: msg,
                            afterHidden: function() {
                                el.RemoveBubblePopup();
                            }
                          };

                        /* use these to calc best position/align of popup */
                        var coords = el.attr("id").split("-"), row = parseInt(coords[1]), col = parseInt(coords[3]);

                        var lon = photo.photo_album.group.group_lon;
                        //if(lon < 0) {
                            // see andrew on explaination
                            lon = (((lon + 180) - 60) / 45) * 240;
                        //}
                        var h = lon, s = 100, v = 100;

                        el.data("msg", msg)
                          .addClass("present").animate({"opacity":0.75}, 500)
                          .append(content)
                          .hover(function() {
                            el.animate({"opacity":1.0}, 500);
                            if(!el.HasBubblePopup()){
                                el.CreateBubblePopup(bubbleOpts);
                            }
                          }, function() {
                              el.animate({"opacity":0.75}, 500);
                          });
                    }
                    inject(nextSlot()
                      .empty()
                      .removeClass("present")
                      .css({"opacity":0})
                      .animate({"opacity":1.0}, 400));
                }
             };
          })();

         Grid.fill();
         var stm = mu.Photos(function(photo) {
         	var eventText = "";
         	var caption = "";
         	if (photo.photo_album.event) {
         		eventText = ": "+photo.photo_album.event.name;
         	}
         	if (photo.caption) {
         		caption = '"'+photo.caption+'"';
         	}
         
         	$("#big-img").fadeOut(function() {
         		$("#big-img").empty();
         		$("#big-img").append('<img src="'+photo.photo_link+
         				'" /><p>'+photo.photo_album.group.name+eventText+
         				'<br><i>Photo by: '+photo.member.name+'</i><br>'+caption+'</p>');
         		$("#big-img").fadeIn();
         	});
         	
         	Grid.add(photo);
         });

         var randomPopup = function() {
             var slot = Grid.randomSlot(),
             el = $(['#r-', slot[0], '-c-', slot[1]].join(''));
             if(el.children().length > 0 && el.data()['msg'] != undefined) {
                 var msg = el.data()['msg'];
                 bubbleOpts = {
                     themePath: '../images/jquerybubblepopup-theme',
                     themeName: 'all-black',
                     innerHtml: msg,
                    /* tail: {
                         align:'left'
                     },*/
                     afterHidden: function() {
                         el.RemoveBubblePopup();
                     },
                     afterShown: function() {
                         var h = function() {
                             el.HideBubblePopup();
                         };
                         setTimeout(h, 3000);
                     }
                 };
                 if(!el.HasBubblePopup()) {
                     el.CreateBubblePopup(bubbleOpts);
                 }
                 el.ShowBubblePopup();
             }
         };

         //setInterval(randomPopup, 7000);

      });
    </script>
  <body>
<html>
