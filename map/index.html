<!DOCTYPE html>
<html>
  <head>
    <title>Streaming MEMEs</title>
    <link rel="stylesheet" type="text/css" href="../css/jquery.bubblepopup.v2.3.1.css" />
    <link rel="stylesheet" type="text/css" href="map.css" />
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="polymaps.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <div id="rsvp-detail"></div>
    <script type="text/javascript" src="jquery.svg.min.js"></script>
    <script type="text/javascript" src="jquery.svgdom.min.js"></script>
    <script type="text/javascript" src="../js/dates.js"></script>
    <script type="text/javascript" src="../js/mu.js" ></script>
    <script type="text/javascript" src="../js/jquery.bubblepopup.v2.3.1.min.js"></script>
    <script type="text/javascript">
      var details = $("#details");
      var Map = (function() {
          var expiry = 3600000,
          po = org.polymaps,
          map = po.map()
              .container(document.getElementById("map")
                         .appendChild(po.svg("svg")))
              .center({lat: 39, lon: -96})
              .zoom(4)
              .add(po.interact())
              .add(po.image()
                  .url(po.url("http://{S}tile.cloudmade.com"
                      + "/dbe72e38b0404199b0d8cfdaac26999b" // get yr own key pls @ http://cloudmade.com/register
                      + "/30389/256/{Z}/{X}/{Y}.png")
                       .hosts(["a.", "b.", "c.", ""])))
              .add(po.compass().pan("none"));

          var load = function(e) {
            for (var i = 0, len = e.features.length; i < len; i++) {
              var feature = e.features[i],
                 rsvp = feature.data.properties.rsvp;

                var f = $(feature.element, $("#map").svg())
                    .animate({ "opacity":0.25 }, 500)
                    .addClass(rsvp.response === "yes" ? "rsvp-yes" : "rsvp-no"),

                time = new Date(rsvp.mtime),

                simpleMsg = ['<div class="rsvp"><span class="member-photo"><img src="',rsvp.member.photo,
                       '"/></span><div class="member-info"> <span class="member">', rsvp.member.member_name,
                        '</span> is meeting up with<br/> <span class="group">', rsvp.group.group_name, '</span>'].join(''),

                msg = ['<div class="rsvp"><span class="member-photo"><img src="',rsvp.member.photo,
                       '"/></span><div class="member-info"> <span class="member">', rsvp.member.member_name,
                       '</span> is meeting up with<br/> ',
                       '<span class="group">', rsvp.group.group_name,
                       '</span><br/> in <span class="place">', rsvp.group.group_city, ', ',
                       (rsvp.group.group_state ? rsvp.group.group_state : rsvp.group.group_country).toUpperCase(),
                       '</span> <span class="time"> ', time.format('h:MMtt'),  ' on ' , time.format('ddd mmm dS'), '</span></div></div>'].join(''),

                bubbleOpts = {
                    alwaysVisible: true,
                    themePath: '../images/jquerybubblepopup-theme',
                    themeName: 'all-black',
                    innerHtml: simpleMsg,
                    afterHidden: function() {
                       f.RemoveBubblePopup();
                    }
                 };

                f.hover(function(e) {
                   f.animate({ "opacity":1 }, 500);
                    if(!f.HasBubblePopup()) {
                      f.CreateBubblePopup(bubbleOpts);
                    }
                    f.ShowBubblePopup();
                }, function() {
                    f.animate({ "opacity":0.25 }, 500)
                      .HideBubblePopup();
                });

                var rm = function() {
                    f.fadeOut(1500, function() {
                        f.remove();
                    });
                };
                setTimeout(rm, expiry);

                var details = $("#rsvp-detail"),
                  detail = $(msg).hide(),
                  showDetail = function() {
                    details.prepend(detail);
                    detail.slideDown(500, function() {
                      details.children().each(function(idx) {
                        if (idx > 10) $(this).remove();
                      });
                    });
                  };
                setTimeout(showDetail, 500);
            }
          };

          return {
            plot: function(rsvp) {
              map.add(po.geoJson()
                .features([{
                   geometry: {
                     coordinates: [
                       parseFloat(rsvp.group.group_lon), parseFloat(rsvp.group.group_lat)],
                       type: "Point",
                       radius: 10,
                       text: rsvp.venue && rsvp.venue.venue_name || ""
                   },
                   properties: {
                      rsvp: rsvp
                   }
                }]).on("load", load));
              }
          };
      })();

      var stm = mu.Stream({
        onRsvp: function(rsvp) {
            Map.plot(rsvp);
        },
        filter: function(rsvp) {
            return rsvp.member.photo != undefined &&
                rsvp.response === "yes";
        }
      });
    </script>
  </body>
</html>