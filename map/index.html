<!DOCTYPE html>
<html>
  <head>
    <title>Streaming MEMEs</title>
    <link rel="stylesheet" type="text/css" href="../css/jquery.bubblepopup.v2.3.1.css" />
    <link rel="stylesheet" type="text/css" href="map.css" />
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="polymaps.min.js"></script>
  </head>
  <body>
    <div id="map">
      <div id="plug">
        <a target="_blank" href="http://meetup.com/meetup_api"><img alt="Powered by Meetup API" src ="meetupapi.png" /></a>
      </div>
    </div>
    <div id="rsvp-detail"></div>
    <script type="text/javascript" src="jquery.svg.min.js"></script>
    <script type="text/javascript" src="jquery.svgdom.min.js"></script>
    <script type="text/javascript" src="jquery.svganim.min.js"></script>
    <script type="text/javascript" src="../js/dates.js"></script>
    <script type="text/javascript" src="../js/mu.js" ></script>
    <script type="text/javascript" src="../js/jquery.bubblepopup.v2.3.1.min.js"></script>
    <script type="text/javascript" src="../js/jquery-ui.min.js"></script>
    <script type="text/javascript">
      var details = $("#details"), uuid = 0, rsvps = {}, cleanupInterval = 2000, domrm = function(rid) {
          var p = $("#"+rid);
          p.animate({opacity:0, svgR:0}, 1500, function() {
              if(p.HasBubblePopup()) {
                  p.RemoveBubblePopup();
              }
              p.remove();
          });
      }, cleanup = function() {
          var now = +new Date();
          for(var id in rsvps) {
              if(now > rsvps[id]) {
                  domrm(id);
                  delete rsvps[id];
              }
          }
      };
      setInterval(cleanup, cleanupInterval);

      $("#map .present").live('mouseenter mouseleave', function(e) {
        var r = $(this), x = e.clientX, y = e.clientY, bubbleOpts = {
            alwaysVisible: true,
            themePath: '../images/jquerybubblepopup-theme',
            themeName: 'all-black',
            width:250,
            innerHtml: r.data()['rsvp']
        };;
        /* jquery bubblepopup doesn't do a great job at positioning when close to edge, rectify this using x, y */
        if(x < 20) {
            bubbleOpts.position = 'right';
        } else if(x < 150) {
            bubbleOpts.align = 'left';
            bubbleOpts.tail = {
                align: 'left'
            };
        }
        if(y < 80) {
            bubbleOpts.position = 'bottom';
        }
        if(e.type === 'mouseenter') {
            $(r.children()[0]).animate({ "opacity":1 }, 500);
            if(!r.HasBubblePopup()) {
              r.CreateBubblePopup(bubbleOpts);
            }
            r.ShowBubblePopup();
        } else if(e.type==='mouseleave') {
            $(r.children()[0]).animate({ "opacity":0.25 }, 500);
            if(r.HasBubblePopup()) {
                r.HideBubblePopup();
            }
        }
      });

     var Map = (function() {
         var expiry = 1800000,
          po = org.polymaps,
          map = po.map()
              .container(document.getElementById("map")
                         .appendChild(po.svg("svg")))
              .center({lat: 27, lon: 5})
              .zoom(2.3)
              .add(po.interact())
              .add(po.image()
                  .url(po.url("http://{S}tile.cloudmade.com"
                      + "/dbe72e38b0404199b0d8cfdaac26999b" // get yr own key pls @ http://cloudmade.com/register
                      + "/30389/256/{Z}/{X}/{Y}.png")
                       .hosts(["a.", "b.", "c.", ""])))
              .add(po.compass().pan("none"));

          var load = function(e) {
            for (var i = 0, len = e.features.length; i < len; i++) {
              var feature = e.features[i],
                 rsvp = feature.data.properties.rsvp;

                var f = $(feature.element, $("#map").svg()), p = f.parent(), t = f.attr("transform"),
                  m = /translate\((\S+),(\S+)\)/.exec(t), tx = parseFloat(m[1]), ty = parseFloat(m[2]);

                p.addClass("present").attr("id", "r-"+uuid++);

                f.attr({"transform":  "translate("+tx+","+(ty-30)+")"});
                f.animate({ "opacity":0.25, svgTransform:t }, 500)
                    .addClass(rsvp.response === "yes" ? "rsvp-yes" : "rsvp-no");

                var time = new Date(rsvp.mtime),

                simpleMsg = ['<div class="rsvp"><span class="member-photo"><img src="',rsvp.member.photo,
                       '"/></span><div class="member-info"> <span class="member">', rsvp.member.member_name,
                             '</span> will meetup with<br/> <span class="group">', rsvp.group.group_name, '</span> in <span class="place">',
                             rsvp.group.group_city, ', ',
                              (rsvp.group.group_state ? rsvp.group.group_state : rsvp.group.group_country).toUpperCase(),
                             '</span></div>'].join(''),

                msg = ['<div class="rsvp"><span class="member-photo"><img src="',rsvp.member.photo,
                       '"/></span><div class="member-info"> <span class="member">', rsvp.member.member_name,
                       '</span> will meetup with<br/> ',
                       '<span class="group">', rsvp.group.group_name,
                       '</span><br/> in <span class="place">', rsvp.group.group_city, ', ',
                       (rsvp.group.group_state ? rsvp.group.group_state : rsvp.group.group_country).toUpperCase(),
                       '</span><br/> <span class="time">RSVP ', time.format('h:Mtt Z'), '</span></div></div>'].join('');

                p.data('rsvp', simpleMsg);

                /* push this map entry in a queue to be removed from the dom at a given time */
                rsvps[p.attr("id")] = +new Date()+expiry;

                var details = $("#rsvp-detail"),
                  detail = $(msg).hide(),
                  showDetail = function() {
                    details.prepend(detail);
                    detail.css({opacity:0}).animate({height:'toggle', opacity:1}, 500, function() {
                      details.children().each(function(idx) {
                        if (idx > 10) $(this).remove();
                      });
                        details = null;
                    });

                  };
                setTimeout(showDetail, 500);
            }
          };

          return {
            plot: function(rsvp) {
              map.add(po.geoJson()
                .features([{
                   geometry: {
                     coordinates: [
                       parseFloat(rsvp.group.group_lon), parseFloat(rsvp.group.group_lat)],
                       type: "Point",
                       radius: 10,
                       text: rsvp.venue && rsvp.venue.venue_name || ""
                   },
                   properties: {
                      rsvp: rsvp
                   }
                }]).on("load", load));
              }
          };
      })();

      var stm = mu.Stream({
        onRsvp: function(rsvp) {
            Map.plot(rsvp);
        },
        filter: function(rsvp) {
            return rsvp.member.photo != undefined &&
                rsvp.response === "yes";
        }
      });

      $(window).bind("unload", function() {
        $("*").add(document).unbind();
      });
      setTimeout(function() {
        // you win, memory leaks! (reload after 6 hours)
        window.location.reload();
      }, 21600000);
      </script>
  </body>
</html>